const e=["2","4","8","16","32","64","128","256","512","1024","2048"],t=["#EEE4DA","#EDE0C8","#EDA166","#F08151","#F1654D","#F1462E","#E8C65F","#E8C34F","#E8BE40","#E8BB31","#E8B724"],l=[70,70,70,60,60,60,50,50,50,50,40],r=128;/** @type {HTMLCanvasElement} */let o=document.createElement("canvas"),a=o.getContext("2d");o.width=600,o.height=600,o.style.cssText="position: absolute; top: 0; left: 0; bottom: 0; right: 0; margin: auto;",document.body.appendChild(o),document.body.style.backgroundColor="#F9F7EB";let n=Array.from({length:4},()=>[,,,,].fill(-1)),i=0,u=[],c=-1;document.addEventListener("keydown",e=>{let t=d[e.key];t&&s(t,n,e.key)});const s=async(e,t,l)=>{u=[],c=-1;let r=e(t);if(r.toString()===t.toString())return;n=r;let o=await f(u,l);cancelAnimationFrame(o),E()},f=(e,t,l=r)=>new Promise(r=>{let o=(e,l)=>e.map(({index:e,val:r,start:o,end:a})=>{let n=(a-o)*l;return"ArrowUp"===t?{x:e,y:3-o-n,val:r}:"ArrowDown"===t?{x:e,y:o+n,val:r}:"ArrowLeft"===t?{x:3-o-n,y:e,val:r}:"ArrowRight"===t?{x:o+n,y:e,val:r}:void 0}),i=null,u=[],c=null,s=t=>{startTime||(startTime=t),a.clearRect(0,0,600,600),p(),A(n),u.forEach(({x:e,y:t,val:l})=>x(e,t,l)),i=t-null,elapsedTime<l?(u=o(e,i/l),requestAnimationFrame(s)):r(c)};c=requestAnimationFrame(s)}),h=e=>{c++;let t=[],l=!1;for(let r=e.length-1;r>=0;r--)-1!==e[r]&&(l&&e[r]===t[0]?(i=Math.max(++t[0],i),l=!1):(t.unshift(e[r]),l=!0),u.push({index:c,val:e[r],start:r,end:e.length-t.length}));return Array(e.length-t.length).fill(-1).concat(t)},m=e=>e[0].map((t,l)=>e.map(e=>e[l])),d={ArrowUp:e=>e.map(e=>h(e.reverse()).reverse()),ArrowDown:e=>e.map(e=>h(e)),ArrowLeft:e=>m(m(e).map(e=>h(e.reverse()).reverse())),ArrowRight:e=>m(m(e).map(e=>h(e)))},E=()=>{if(g())alert("你赢了");else{let{x:e,y:t}=B(n);n[e][t]=0}a.clearRect(0,0,600,600),p(),F(n),y()&&console.log(`\u{4F60}\u{8F93}\u{4E86}\u{FF01}\u{6700}\u{9AD8}\u{5206}\u{FF1A}${e[i]}`)},g=()=>i===e.length-1,y=()=>{for(let e=0;e<4;e++)for(let t=0;t<4;t++)// 游戏未结束条件：1.本身是空值 2.下方没有相同值 3.右侧没有相同值
if(-1===n[e][t]||t<3&&n[e][t]===n[e][t+1]||e<3&&n[e][t]===n[e+1][t])return!1;return!0},x=(r,o,n)=>{let[i,u,c]=[e,t,l].map(e=>e[n]);w(r,o,u),a.font=`${c}px serif`,a.fillStyle=n<2?"#645B52":"#F7F4EF";let s=a.measureText(i),f=s.actualBoundingBoxLeft+s.actualBoundingBoxRight,h=s.actualBoundingBoxAscent+s.actualBoundingBoxDescent;a.fillText(i,145*r+20+(125-f)/2,145*o+20+h+(125-h)/2)},A=e=>e.forEach((e,t)=>e.forEach((e,l)=>w(t,l))),F=e=>e.forEach((t,l)=>t.forEach((t,r)=>{w(l,r),-1!==e[l][r]&&x(l,r,e[l][r])})),p=()=>{a.fillStyle="#AD9D8F",a.fillRect(0,0,600,600)},w=(e,t,l="#C2B4A5")=>{a.fillStyle=l,a.fillRect(145*e+20,145*t+20,125,125)},B=e=>{let t=[];return e.forEach((l,r)=>l.forEach((l,o)=>-1===e[r][o]&&t.push({x:r,y:o}))),t[Math.floor(Math.random()*t.length)]};window.onload=()=>{for(let e=0;e<2;e++){let{x:e,y:t}=B(n);n[e][t]=0}p(),F(n)};