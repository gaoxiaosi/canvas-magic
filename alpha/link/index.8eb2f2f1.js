const e=100,t=e/2+10,l=Math.floor((window.innerHeight-2*t-10)/(e+10)),o=Math.floor((window.innerWidth-2*t-10)/(e+10))-(l%2==1),r=o*(e+10)+10+2*t,i=l*(e+10)+10+2*t,n=["./1.jpg","./2.jpg","./3.jpg","./4.jpg","./5.jpg","./6.jpg","./7.jpg","./8.jpg","./9.jpg","./10.jpg","./11.jpg","./12.jpg","./13.jpg","./14.jpg","./15.jpg","./16.jpg","./17.jpg","./18.jpg","./19.jpg","./20.jpg"],y=["#409EFF","#67C23A","#E6A23C","#F56C6C","#b37feb","#ff85c0","#36cfc9"],f="#00aeec",s="#00aeec",a=r/4,x="#F8BBD0";let c=document.createElement("canvas"),g=c.getContext("2d");c.width=r,c.height=i,c.style.cssText="position: absolute; inset: 0; margin: auto; cursor: pointer;",document.body.appendChild(c),document.body.style.backgroundColor="rgba(0, 174, 236, 0.5)";let p=Array.from({length:o+2},()=>Array(l+2).fill(-1)),h={x:-1,y:-1},d={x:-1,y:-1},u={x:-1,y:-1},j={x:-1,y:-1},m={x:-1,y:-1},E={x:-1,y:-1},w=!1,S=0,k=null,b=null,C=!1,v=[],A=Array(n.length).fill(!1);document.addEventListener("keydown",e=>"A"===e.key.toUpperCase()&&null===b&&(b=setInterval(()=>O(),1e3)));const O=async()=>{h=m,j=E;let{x:e,y:t}=h,{x:l,y:o}=j;I(e,t),I(l,o),U(),p[e][t]=-1,p[l][o]=-1,S++,await T(512),$(),C&&(clearInterval(b),console.log(p),alert("你赢了"))};c.onclick=async l=>{let[o,r]=[l.offsetX,l.offsetY].map(l=>Math.ceil((l-t)/(e+10)));if(!(l.offsetX-(o-1)*(e+10)-t<10)&&!(l.offsetY-(r-1)*(e+10)-t<10)&&-1!==p[o][r]){if(w){if(w=!1,o===h.x&&r===h.y){M(o,r),L(o,r,p[o][r]);return}j={x:o,y:r},W(h,j)?(I(j.x,j.y),U(),p[h.x][h.y]=-1,p[j.x][j.y]=-1,await T(256),$(),S++,C&&alert("你赢了")):(M(h.x,h.y),L(h.x,h.y,p[h.x][h.y]),h={x:o,y:r},I(o,r))}else h={x:o,y:r},w=!0,I(o,r)}};const T=e=>new Promise(t=>setTimeout(t,e)),J=()=>2*S==l*o&&(C=!0),N=(e,t)=>{let{x:l,y:o}=e,{x:r,y:i}=t;return l===r?(o>i&&([o,i]=[i,o]),p[l].slice(o+1,i).every(e=>-1===e)):o===i&&(l>r&&([l,r]=[r,l]),p.slice(l+1,r).every(e=>-1===e[o]))},R=(e,t)=>{let{x:l,y:o}=e,{x:r,y:i}=t;for(let[e,n]of[[1,0],[-1,0],[0,1],[0,-1]]){let y=0,f=l,s=o;for(;p[f=l+e*++y]?.[s=o+n*y]===-1;)if(d={x:f,y:s},u=0===e?{x:r,y:s}:{x:f,y:i},JSON.stringify(u)===JSON.stringify(t)&&N(d,t)||-1===p[u.x][u.y]&&N(d,u)&&N(u,t))return!0}return!1},W=(e,t)=>(d=e,u=t,p[e.x][e.y]===p[t.x][t.y]&&(!!N(e,t)||R(e,t))),F=()=>{if(C)return!1;let e={};for(let t of(p.forEach((t,l)=>t.forEach((t,o)=>{-1!==t&&(e[t]?e[t].push({x:l,y:o}):e[t]=[{x:l,y:o}])})),Object.values(e)))for(let e=0;e<t.length;e++)for(let l=e+1;l<t.length;l++)if(W(t[e],t[l]))return m=t[e],E=t[l],!0;return!1},I=(t,l,o=f)=>{g.strokeStyle=o,g.lineWidth=5,g.strokeRect(X(t),X(l),e,e)},M=(t,l)=>{g.strokeStyle=x,g.lineWidth=10,g.strokeRect(X(t),X(l),e,e)},B=()=>{g.fillStyle=x,g.fillRect(t,t,r-2*t,i-2*t)},P=()=>{g.font=`${a}px serif`,g.fillStyle="#00AEEC",g.textBaseline="middle",g.textAlign="center",g.fillText("bilibili",r/2,i/2)},X=l=>(l-1)*(e+10)+10+t,Y=e=>e.sort(()=>Math.random()-.5),D=()=>{let e=[],t=0;for(let r=0;r<l*o/2;r++)t=r%n.length,e.push(t,t);let r=Y(e);for(let e=1;e<o+1;e++)for(let t=1;t<l+1;t++)p[e][t]=r.pop()},H=()=>{console.log("需要打乱数据");let e=[];for(let t=1;t<o+1;t++)for(let o=1;o<l+1;o++)e.push(p[t][o]);let t=Y(e);for(let e=1;e<o+1;e++)for(let o=1;o<l+1;o++)p[e][o]=t.pop()},L=(t,l,o,r=e)=>{t=X(t),l=X(l),g.strokeStyle=x,g.lineWidth=10,g.strokeRect(t-5,l-5,r+10,r+10),A[o]?g.drawImage(v[o],t,l,r,r):(g.fillStyle=y[o%y.length],g.fillRect(t,l,r,r))},U=(t=[h,d,u,j],l=5,o=s)=>{JSON.stringify(u)===JSON.stringify(j)&&t.splice(2,1),JSON.stringify(h)===JSON.stringify(d)&&t.splice(1,1);let r=(t=t.map(e=>({...e,ox:.5,oy:.5}))).length;t[0].x===t[1].x?t[0].oy=+(t[0].y<t[1].y):t[0].ox=+(t[0].x<t[1].x),t[r-1].x===t[r-2].x&&(t[r-1].oy=+(t[r-1].y<t[r-2].y)),t[r-1].y===t[r-2].y&&(t[r-1].ox=+(t[r-1].x<t[r-2].x)),t=t.map(({x:t,y:l,ox:o,oy:r})=>({x:X(t)+e*o,y:X(l)+e*r})),g.lineWidth=l,g.strokeStyle=o,g.beginPath();let{x:i,y:n}=t.shift();g.moveTo(i,n),t.forEach(({x:e,y:t})=>g.lineTo(e,t)),g.stroke()},$=()=>{if(clearTimeout(k),!J()){for(;!F();)H();k=setTimeout(()=>{I(m.x,m.y,"red"),I(E.x,E.y,"red")},5e3)}g.clearRect(0,0,r,i),B(),P(),p.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&L(t,l,e)))},q=async()=>{D(),n.forEach((e,t)=>{if(A[t])return;let l=new Image;l.src=e,v[t]=l,l.onload=()=>{A[t]=!0,p.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&L(t,l,e)))}}),$()};window.onload=q;