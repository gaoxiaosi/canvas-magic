const e=125,a=4*e+100,t=4*e+100,l="#C2B4A5",n=6,r=["2","4","8","16","32","64","128","256","512","1024","2048"],o=["#EEE4DA","#EDE0C8","#EDA166","#F08151","#F1654D","#F1462E","#E8C65F","#E8C34F","#E8BE40","#E8BB31","#E8B724"],i=[70,70,70,60,60,60,50,50,50,50,40],c=64,s=128,h=.35;// 最大缩放比例
/** @type {HTMLCanvasElement} */let u=document.createElement("canvas"),m=u.getContext("2d");u.width=a,u.height=t,u.style.cssText="position: absolute; inset: 0; margin: auto;",document.body.appendChild(u),document.body.style.backgroundColor="#F9F7EB";let d=Array.from({length:4},()=>[,,,,].fill(-1)),x=0,f=[],y=[],v=[],E=[];document.addEventListener("keydown",e=>{let a=T[e.key];a&&g(a,d,e.key)});const g=async(e,a,t)=>{y=[],f=[],E=[],v=[];let l=e(JSON.parse(JSON.stringify(a)),t);if(l.toString()===a.toString())return;d=l;let n=await w(y,f,t);if(cancelAnimationFrame(n),E.length>0){let e=A[t];E=E.map(({index:a,end:t,val:l})=>e(a,t,l)),v=v.map(({index:a,end:t,val:l})=>e(a,t,l));let a=await F(E,v);cancelAnimationFrame(a)}C()},p={ArrowUp:(e,a,t,l)=>({x:e,y:3-a-l,val:t}),ArrowDown:(e,a,t,l)=>({x:e,y:a+l,val:t}),ArrowLeft:(e,a,t,l)=>({x:3-a-l,y:e,val:t}),ArrowRight:(e,a,t,l)=>({x:a+l,y:e,val:t})},A={ArrowUp:(e,a,t)=>({x:e,y:3-a,val:t}),ArrowDown:(e,a,t)=>({x:e,y:a,val:t}),ArrowLeft:(e,a,t)=>({x:3-a,y:e,val:t}),ArrowRight:(e,a,t)=>({x:a,y:e,val:t})},w=(e,l,n,r=c)=>new Promise(o=>{let i=null,c=null,s=[],h=null,u=p[n],x=A[n];l=l.map(({index:e,end:a,val:t})=>x(e,a,t));let f=n=>{i||(i=n),m.clearRect(0,0,a,t),k(),L(d),l.forEach(({x:e,y:a,val:t})=>b(e,a,t)),s.forEach(({x:e,y:a,val:t})=>b(e,a,t)),(c=n-i)<r?(s=e.map(({index:e,start:a,val:t,distance:l})=>u(e,a,t,l*c/r)),// activeGroup = moveGroup.map(({index, start, val, distance}) => getMovePos(index, start, val, distance * Math.sin(elapsed / duration * Math.PI / 2)));
    requestAnimationFrame(f)):o(h)};h=requestAnimationFrame(f)}),F=(l,n,r=s,o=h)=>new Promise(i=>{let c=null,s=null,h=null,u=0,x=f=>{c||(c=f),m.clearRect(0,0,a,t),k(),L(d),n.forEach(({x:e,y:a,val:t})=>b(e,a,t)),l.forEach(({x:a,y:t,val:l})=>b(a-u/2,t-u/2,l,e+e*u)),(s=f-c)<r?(// scaleRatio = (1 - Math.abs(1 - elapsed / duration * 2)) * 0.2
    u=Math.sin(s/r*Math.PI)*o,requestAnimationFrame(x)):i(h)};h=requestAnimationFrame(x)}),B=(e,a)=>{let t=[],l=!1,n=e.length;for(let r=n-1;r>=0;r--)-1!==e[r]&&(l&&e[r]===t[0]?(x=Math.max(++t[0],x),l=!1,E.push({index:a,val:e[r],end:n-t.length}),v.pop()):(t.unshift(e[r]),v.push({index:a,val:e[r],end:n-t.length}),l=!0),0==n-t.length-r?f.push({index:a,val:e[r],end:r}):y.push({index:a,val:e[r],start:r,distance:n-t.length-r}));return Array(n-t.length).fill(-1).concat(t)},D=e=>e[0].map((a,t)=>e.map(e=>e[t])),T={ArrowUp:e=>e.map((e,a)=>B(e.reverse(),a).reverse()),ArrowDown:e=>e.map((e,a)=>B(e,a)),ArrowLeft:e=>D(D(e).map((e,a)=>B(e.reverse(),a).reverse())),ArrowRight:e=>D(D(e).map((e,a)=>B(e,a)))},C=async()=>{if(M())console.log("你赢了");else{let e=[];d.forEach((a,t)=>a.forEach((a,l)=>-1!==a&&e.push({x:t,y:l,val:a})));let{x:a,y:t}=J(d),l=.5>Math.random()?0:1;d[a][t]=l,R()&&console.log(`\u{4F60}\u{8F93}\u{4E86}\u{FF01}\u{6700}\u{9AD8}\u{5206}\u{FF1A}${r[x]}`),await F([{x:a,y:t,val:l}],e)}m.clearRect(0,0,a,t),k(),P(d)},M=()=>x===r.length-1,R=()=>!d.some((e,a)=>e.some((t,l)=>-1===t||t===e[l+1]||t===d[a+1]?.[l])),S=async()=>{let e=[];for(let a=0;a<2;a++){let{x:a,y:t}=J(d),l=.5>Math.random()?0:1;d[a][t]=l,e.push({x:a,y:t,val:l})}await F(e,[]),k(),P(d)},b=(a,t,l,n=e)=>{let[c,s,h]=[r,o,i].map(e=>e[l]);q(a,t,s,n),m.font=`${h}px serif`,m.fillStyle=l<2?"#645B52":"#F7F4EF";let u=m.measureText(c),d=u.actualBoundingBoxLeft+u.actualBoundingBoxRight,x=u.actualBoundingBoxAscent+u.actualBoundingBoxDescent;m.fillText(c,a*(20+e)+20+(n-d)/2,t*(20+e)+20+x+(n-x)/2)},L=e=>e.forEach((e,a)=>e.forEach((e,t)=>q(a,t))),P=e=>e.forEach((e,a)=>e.forEach((e,t)=>{q(a,t),-1!==e&&b(a,t,e)})),k=()=>U(0,0,a,t,6,"#AD9D8F"),q=(a,t,n=l,r=e)=>U(a*(20+e)+20,t*(20+e)+20,r,r,6,n),U=(e,a,t,l,r=n,o)=>{m.beginPath(),m.moveTo(e+r,a),m.arcTo(e+t,a,e+t,a+l,r),m.arcTo(e+t,a+l,e,a+l,r),m.arcTo(e,a+l,e,a,r),m.arcTo(e,a,e+t,a,r),m.closePath(),(m.fillStyle=o)&&(m.fillStyle=o,m.fill())},J=e=>{let a=[];return e.forEach((t,l)=>t.forEach((t,n)=>-1===e[l][n]&&a.push({x:l,y:n}))),a[Math.floor(Math.random()*a.length)]};window.onload=S;