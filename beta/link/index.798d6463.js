const e=100,t=e/2+10,l=Math.floor((window.innerHeight-2*t-10)/(e+10)),o=Math.floor((window.innerWidth-2*t-10)/(e+10))-(l%2==1),r=o*(e+10)+10+2*t,n=l*(e+10)+10+2*t,i=["./1.jpg","./2.jpg","./3.jpg","./4.jpg","./5.jpg","./6.jpg","./7.jpg","./8.jpg","./9.jpg","./10.jpg","./11.jpg","./12.jpg","./13.jpg","./14.jpg","./15.jpg","./16.jpg","./17.jpg","./18.jpg","./19.jpg","./20.jpg"],y=["#409EFF","#67C23A","#E6A23C","#F56C6C","#b37feb","#ff85c0","#36cfc9"],f="#00aeec",a="#00aeec",s=r/4,c="#F8BBD0";let x=document.createElement("canvas"),g=x.getContext("2d");x.width=r,x.height=n,x.style.cssText="position: absolute; inset: 0; margin: auto; cursor: pointer;",document.body.appendChild(x),document.body.style.backgroundColor="rgba(0, 174, 236, 0.5)";let p=Array.from({length:o+2},()=>Array(l+2).fill(-1)),d={x:-1,y:-1},h={x:-1,y:-1},u={x:-1,y:-1},j={x:-1,y:-1},m={x:-1,y:-1},E={x:-1,y:-1},w=!1,S=0,k=null,v=null,b=!1,C=[],A=Array(i.length).fill(!1);document.addEventListener("keydown",e=>"A"===e.key.toUpperCase()&&null===v&&(v=setInterval(()=>O(),1e3))),document.addEventListener("touchstart",e=>v=setInterval(()=>O(),1e3)),document.addEventListener("touchend",e=>clearInterval(v));const O=async()=>{d=m,j=E;let{x:e,y:t}=d,{x:l,y:o}=j;F(e,t),F(l,o),U(),p[e][t]=-1,p[l][o]=-1,S++,await T(512),$(),b&&(clearInterval(v),console.log(p),alert("你赢了"))};x.onclick=async l=>{let[o,r]=[l.offsetX,l.offsetY].map(l=>Math.ceil((l-t)/(e+10)));if(!(l.offsetX-(o-1)*(e+10)-t<10)&&!(l.offsetY-(r-1)*(e+10)-t<10)&&-1!==p[o][r]){if(w){if(w=!1,o===d.x&&r===d.y){M(o,r),H(o,r,p[o][r]);return}j={x:o,y:r},R(d,j)?(F(j.x,j.y),U(),p[d.x][d.y]=-1,p[j.x][j.y]=-1,await T(256),$(),S++,b&&alert("你赢了")):(M(d.x,d.y),H(d.x,d.y,p[d.x][d.y]),d={x:o,y:r},F(o,r))}else d={x:o,y:r},w=!0,F(o,r)}};const T=e=>new Promise(t=>setTimeout(t,e)),I=()=>2*S==l*o&&(b=!0),J=(e,t)=>{let{x:l,y:o}=e,{x:r,y:n}=t;return l===r?(o>n&&([o,n]=[n,o]),p[l].slice(o+1,n).every(e=>-1===e)):o===n&&(l>r&&([l,r]=[r,l]),p.slice(l+1,r).every(e=>-1===e[o]))},N=(e,t)=>{let{x:l,y:o}=e,{x:r,y:n}=t;for(let[e,i]of[[1,0],[-1,0],[0,1],[0,-1]]){let y=0,f=l,a=o;for(;p[f=l+e*++y]?.[a=o+i*y]===-1;)if(h={x:f,y:a},u=0===e?{x:r,y:a}:{x:f,y:n},JSON.stringify(u)===JSON.stringify(t)&&J(h,t)||-1===p[u.x][u.y]&&J(h,u)&&J(u,t))return!0}return!1},R=(e,t)=>(h=e,u=t,p[e.x][e.y]===p[t.x][t.y]&&(!!J(e,t)||N(e,t))),W=()=>{if(b)return!1;let e={};for(let t of(p.forEach((t,l)=>t.forEach((t,o)=>{-1!==t&&(e[t]?e[t].push({x:l,y:o}):e[t]=[{x:l,y:o}])})),Object.values(e)))for(let e=0;e<t.length;e++)for(let l=e+1;l<t.length;l++)if(R(t[e],t[l]))return m=t[e],E=t[l],!0;return!1},F=(t,l,o=f)=>{g.strokeStyle=o,g.lineWidth=5,g.strokeRect(P(t),P(l),e,e)},M=(t,l)=>{g.strokeStyle=c,g.lineWidth=10,g.strokeRect(P(t),P(l),e,e)},B=()=>{g.fillStyle=c,g.fillRect(t,t,r-2*t,n-2*t)},L=()=>{g.font=`${s}px serif`,g.fillStyle="#00AEEC",g.textBaseline="middle",g.textAlign="center",g.fillText("bilibili",r/2,n/2)},P=l=>(l-1)*(e+10)+10+t,X=e=>e.sort(()=>Math.random()-.5),Y=()=>{let e=[],t=0;for(let r=0;r<l*o/2;r++)t=r%i.length,e.push(t,t);let r=X(e);for(let e=1;e<o+1;e++)for(let t=1;t<l+1;t++)p[e][t]=r.pop()},D=()=>{console.log("需要打乱数据");let e=[];for(let t=1;t<o+1;t++)for(let o=1;o<l+1;o++)e.push(p[t][o]);let t=X(e);for(let e=1;e<o+1;e++)for(let o=1;o<l+1;o++)p[e][o]=t.pop()},H=(t,l,o,r=e)=>{t=P(t),l=P(l),g.strokeStyle=c,g.lineWidth=10,g.strokeRect(t-5,l-5,r+10,r+10),A[o]?g.drawImage(C[o],t,l,r,r):(g.fillStyle=y[o%y.length],g.fillRect(t,l,r,r))},U=(t=[d,h,u,j],l=5,o=a)=>{JSON.stringify(u)===JSON.stringify(j)&&t.splice(2,1),JSON.stringify(d)===JSON.stringify(h)&&t.splice(1,1);let r=(t=t.map(e=>({...e,ox:.5,oy:.5}))).length;t[0].x===t[1].x?t[0].oy=+(t[0].y<t[1].y):t[0].ox=+(t[0].x<t[1].x),t[r-1].x===t[r-2].x&&(t[r-1].oy=+(t[r-1].y<t[r-2].y)),t[r-1].y===t[r-2].y&&(t[r-1].ox=+(t[r-1].x<t[r-2].x)),t=t.map(({x:t,y:l,ox:o,oy:r})=>({x:P(t)+e*o,y:P(l)+e*r})),g.lineWidth=l,g.strokeStyle=o,g.beginPath();let{x:n,y:i}=t.shift();g.moveTo(n,i),t.forEach(({x:e,y:t})=>g.lineTo(e,t)),g.stroke()},$=()=>{if(clearTimeout(k),!I()){for(;!W();)D();k=setTimeout(()=>{F(m.x,m.y,"red"),F(E.x,E.y,"red")},5e3)}g.clearRect(0,0,r,n),B(),L(),p.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&H(t,l,e)))},q=async()=>{Y(),i.forEach((e,t)=>{if(A[t])return;let l=new Image;l.src=e,C[t]=l,l.onload=()=>{A[t]=!0,p.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&H(t,l,e)))}}),$()};window.onload=q;