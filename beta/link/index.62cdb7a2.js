let e;const t=window.innerWidth<500?50:100,l=t/2+10,o=window.innerWidth<500?5:10,r=Math.floor((window.innerHeight-2*l-o)/(t+o)),n=(e=Math.floor((window.innerWidth-2*l-o)/(t+o)),r%2?e-1:e),i=n*(t+o)+o+2*l,y=r*(t+o)+o+2*l,f=["./1.jpg","./2.jpg","./3.jpg","./4.jpg","./5.jpg","./6.jpg","./7.jpg","./8.jpg","./9.jpg","./10.jpg","./11.jpg","./12.jpg","./13.jpg","./14.jpg","./15.jpg","./16.jpg","./17.jpg","./18.jpg","./19.jpg","./20.jpg"],s=["#409EFF","#67C23A","#E6A23C","#F56C6C","#b37feb","#ff85c0","#36cfc9"],a="#00aeec",c="#00aeec",x=i/4,g="#F8BBD0";let d=document.createElement("canvas"),p=d.getContext("2d");d.width=i,d.height=y,d.style.cssText="position: absolute; inset: 0; margin: auto; cursor: pointer;",document.body.appendChild(d),document.body.style.backgroundColor=g;let h=Array.from({length:n+2},()=>Array(r+2).fill(-1)),u={x:-1,y:-1},m={x:-1,y:-1},j={x:-1,y:-1},w={x:-1,y:-1},E={x:-1,y:-1},S={x:-1,y:-1},k=!1,v=0,b=null,C=null,T=null,A=!1,O=[],W=Array(f.length).fill(!1);document.addEventListener("keydown",e=>"A"===e.key.toUpperCase()&&null===C&&(C=setInterval(()=>J(),1e3))),document.addEventListener("touchstart",e=>T=setTimeout(()=>C=setInterval(()=>J(),1e3),3e3)),document.addEventListener("touchend",e=>clearTimeout(T));const J=async()=>{u=E,w=S;let{x:e,y:t}=u,{x:l,y:o}=w;L(e,t),L(l,o),z(),h[e][t]=-1,h[l][o]=-1,v++,await N(512),G(),A&&(clearInterval(C),console.log(h),alert("你赢了"))};d.onclick=async e=>{let[r,n]=[e.offsetX,e.offsetY].map(e=>Math.ceil((e-l)/(t+o)));if(!(e.offsetX-(r-1)*(t+o)-l<o)&&!(e.offsetY-(n-1)*(t+o)-l<o)&&-1!==h[r][n]){if(k){if(k=!1,r===u.x&&n===u.y){P(r,n),q(r,n,h[r][n]);return}w={x:r,y:n},M(u,w)?(L(w.x,w.y),z(),h[u.x][u.y]=-1,h[w.x][w.y]=-1,await N(256),G(),v++,A&&alert("你赢了")):(P(u.x,u.y),q(u.x,u.y,h[u.x][u.y]),u={x:r,y:n},L(r,n))}else u={x:r,y:n},k=!0,L(r,n)}};const N=e=>new Promise(t=>setTimeout(t,e)),R=()=>2*v==r*n&&(A=!0),I=(e,t)=>{let{x:l,y:o}=e,{x:r,y:n}=t;return l===r?(o>n&&([o,n]=[n,o]),h[l].slice(o+1,n).every(e=>-1===e)):o===n&&(l>r&&([l,r]=[r,l]),h.slice(l+1,r).every(e=>-1===e[o]))},F=(e,t)=>{let{x:l,y:o}=e,{x:r,y:n}=t;for(let[e,i]of[[1,0],[-1,0],[0,1],[0,-1]]){let y=0,f=l,s=o;for(;h[f=l+e*++y]?.[s=o+i*y]===-1;)if(m={x:f,y:s},j=0===e?{x:r,y:s}:{x:f,y:n},JSON.stringify(j)===JSON.stringify(t)&&I(m,t)||-1===h[j.x][j.y]&&I(m,j)&&I(j,t))return!0}return!1},M=(e,t)=>(m=e,j=t,h[e.x][e.y]===h[t.x][t.y]&&(!!I(e,t)||F(e,t))),B=()=>{if(A)return!1;let e={};for(let t of(h.forEach((t,l)=>t.forEach((t,o)=>{-1!==t&&(e[t]?e[t].push({x:l,y:o}):e[t]=[{x:l,y:o}])})),Object.values(e)))for(let e=0;e<t.length;e++)for(let l=e+1;l<t.length;l++)if(M(t[e],t[l]))return E=t[e],S=t[l],!0;return!1},L=(e,l,o=a)=>{p.strokeStyle=o,p.lineWidth=5,p.strokeRect(D(e),D(l),t,t)},P=(e,l)=>{p.strokeStyle=g,p.lineWidth=10,p.strokeRect(D(e),D(l),t,t)},X=()=>{p.fillStyle=g,p.fillRect(l,l,i-2*l,y-2*l)},Y=()=>{p.font=`${x}px serif`,p.fillStyle="#00AEEC",p.textBaseline="middle",p.textAlign="center",p.fillText("bilibili",i/2,y/2)},D=e=>(e-1)*(t+o)+o+l,H=e=>e.sort(()=>Math.random()-.5),U=()=>{let e=[],t=0;for(let l=0;l<r*n/2;l++)t=l%f.length,e.push(t,t);let l=H(e);for(let e=1;e<n+1;e++)for(let t=1;t<r+1;t++)h[e][t]=l.pop()},$=()=>{console.log("需要打乱数据");let e=[];for(let t=1;t<n+1;t++)for(let l=1;l<r+1;l++)e.push(h[t][l]);let t=H(e);for(let e=1;e<n+1;e++)for(let l=1;l<r+1;l++)h[e][l]=t.pop()},q=(e,l,r,n=t)=>{e=D(e),l=D(l),p.strokeStyle=g,p.lineWidth=o,p.strokeRect(e-o/2,l-o/2,n+o,n+o),W[r]?p.drawImage(O[r],e,l,n,n):(p.fillStyle=s[r%s.length],p.fillRect(e,l,n,n))},z=(e=[u,m,j,w],l=5,o=c)=>{JSON.stringify(j)===JSON.stringify(w)&&e.splice(2,1),JSON.stringify(u)===JSON.stringify(m)&&e.splice(1,1);let r=(e=e.map(e=>({...e,ox:.5,oy:.5}))).length;e[0].x===e[1].x?e[0].oy=+(e[0].y<e[1].y):e[0].ox=+(e[0].x<e[1].x),e[r-1].x===e[r-2].x&&(e[r-1].oy=+(e[r-1].y<e[r-2].y)),e[r-1].y===e[r-2].y&&(e[r-1].ox=+(e[r-1].x<e[r-2].x)),e=e.map(({x:e,y:l,ox:o,oy:r})=>({x:D(e)+t*o,y:D(l)+t*r})),p.lineWidth=l,p.strokeStyle=o,p.beginPath();let{x:n,y:i}=e.shift();p.moveTo(n,i),e.forEach(({x:e,y:t})=>p.lineTo(e,t)),p.stroke()},G=()=>{if(clearTimeout(b),!R()){for(;!B();)$();b=setTimeout(()=>{L(E.x,E.y,"red"),L(S.x,S.y,"red")},5e3)}p.clearRect(0,0,i,y),X(),Y(),h.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&q(t,l,e)))},K=async()=>{U(),f.forEach((e,t)=>{if(W[t])return;let l=new Image;l.src=e,O[t]=l,l.onload=()=>{W[t]=!0,h.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&q(t,l,e)))}}),G()};window.onload=K;