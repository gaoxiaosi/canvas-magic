const e=window.innerWidth<500?50:100,t=e/2+10,l=window.innerWidth<500?4:10,o=Math.floor((window.innerHeight-2*t-l)/(e+l)),r=Math.floor((window.innerWidth-2*t-l)/(e+l))-(o%2==1),n=r*(e+l)+l+2*t,i=o*(e+l)+l+2*t,y=["./1.jpg","./2.jpg","./3.jpg","./4.jpg","./5.jpg","./6.jpg","./7.jpg","./8.jpg","./9.jpg","./10.jpg","./11.jpg","./12.jpg","./13.jpg","./14.jpg","./15.jpg","./16.jpg","./17.jpg","./18.jpg","./19.jpg","./20.jpg"],f=["#409EFF","#67C23A","#E6A23C","#F56C6C","#b37feb","#ff85c0","#36cfc9"],s="#00aeec",a="#00aeec",c=n/4,x="#F8BBD0";let g=document.createElement("canvas"),d=g.getContext("2d");g.width=n,g.height=i,g.style.cssText="position: absolute; inset: 0; margin: auto; cursor: pointer;",document.body.appendChild(g),document.body.style.backgroundColor=x;let p=Array.from({length:r+2},()=>Array(o+2).fill(-1)),h={x:-1,y:-1},u={x:-1,y:-1},m={x:-1,y:-1},j={x:-1,y:-1},w={x:-1,y:-1},E={x:-1,y:-1},S=!1,k=0,v=null,b=null,C=null,T=!1,A=[],O=Array(y.length).fill(!1);document.addEventListener("keydown",e=>"A"===e.key.toUpperCase()&&null===b&&(b=setInterval(()=>W(),1e3))),document.addEventListener("touchstart",e=>C=setTimeout(()=>b=setInterval(()=>W(),1e3),3e3)),document.addEventListener("touchend",e=>clearTimeout(C));const W=async()=>{h=w,j=E;let{x:e,y:t}=h,{x:l,y:o}=j;B(e,t),B(l,o),q(),p[e][t]=-1,p[l][o]=-1,k++,await J(512),z(),T&&(clearInterval(b),console.log(p),alert("你赢了"))};g.onclick=async o=>{let[r,n]=[o.offsetX,o.offsetY].map(o=>Math.ceil((o-t)/(e+l)));if(!(o.offsetX-(r-1)*(e+l)-t<l)&&!(o.offsetY-(n-1)*(e+l)-t<l)&&-1!==p[r][n]){if(S){if(S=!1,r===h.x&&n===h.y){L(r,n),$(r,n,p[r][n]);return}j={x:r,y:n},F(h,j)?(B(j.x,j.y),q(),p[h.x][h.y]=-1,p[j.x][j.y]=-1,await J(256),z(),k++,T&&alert("你赢了")):(L(h.x,h.y),$(h.x,h.y,p[h.x][h.y]),h={x:r,y:n},B(r,n))}else h={x:r,y:n},S=!0,B(r,n)}};const J=e=>new Promise(t=>setTimeout(t,e)),N=()=>2*k==o*r&&(T=!0),R=(e,t)=>{let{x:l,y:o}=e,{x:r,y:n}=t;return l===r?(o>n&&([o,n]=[n,o]),p[l].slice(o+1,n).every(e=>-1===e)):o===n&&(l>r&&([l,r]=[r,l]),p.slice(l+1,r).every(e=>-1===e[o]))},I=(e,t)=>{let{x:l,y:o}=e,{x:r,y:n}=t;for(let[e,i]of[[1,0],[-1,0],[0,1],[0,-1]]){let y=0,f=l,s=o;for(;p[f=l+e*++y]?.[s=o+i*y]===-1;)if(u={x:f,y:s},m=0===e?{x:r,y:s}:{x:f,y:n},JSON.stringify(m)===JSON.stringify(t)&&R(u,t)||-1===p[m.x][m.y]&&R(u,m)&&R(m,t))return!0}return!1},F=(e,t)=>(u=e,m=t,p[e.x][e.y]===p[t.x][t.y]&&(!!R(e,t)||I(e,t))),M=()=>{if(T)return!1;let e={};for(let t of(p.forEach((t,l)=>t.forEach((t,o)=>{-1!==t&&(e[t]?e[t].push({x:l,y:o}):e[t]=[{x:l,y:o}])})),Object.values(e)))for(let e=0;e<t.length;e++)for(let l=e+1;l<t.length;l++)if(F(t[e],t[l]))return w=t[e],E=t[l],!0;return!1},B=(t,l,o=s)=>{d.strokeStyle=o,d.lineWidth=5,d.strokeRect(Y(t),Y(l),e,e)},L=(t,l)=>{d.strokeStyle=x,d.lineWidth=10,d.strokeRect(Y(t),Y(l),e,e)},P=()=>{d.fillStyle=x,d.fillRect(t,t,n-2*t,i-2*t)},X=()=>{d.font=`${c}px serif`,d.fillStyle="#00AEEC",d.textBaseline="middle",d.textAlign="center",d.fillText("bilibili",n/2,i/2)},Y=o=>(o-1)*(e+l)+l+t,D=e=>e.sort(()=>Math.random()-.5),H=()=>{let e=[],t=0;for(let l=0;l<o*r/2;l++)t=l%y.length,e.push(t,t);let l=D(e);for(let e=1;e<r+1;e++)for(let t=1;t<o+1;t++)p[e][t]=l.pop()},U=()=>{console.log("需要打乱数据");let e=[];for(let t=1;t<r+1;t++)for(let l=1;l<o+1;l++)e.push(p[t][l]);let t=D(e);for(let e=1;e<r+1;e++)for(let l=1;l<o+1;l++)p[e][l]=t.pop()},$=(t,o,r,n=e)=>{t=Y(t),o=Y(o),d.strokeStyle=x,d.lineWidth=l,d.strokeRect(t-l/2,o-l/2,n+l,n+l),O[r]?d.drawImage(A[r],t,o,n,n):(d.fillStyle=f[r%f.length],d.fillRect(t,o,n,n))},q=(t=[h,u,m,j],l=5,o=a)=>{JSON.stringify(m)===JSON.stringify(j)&&t.splice(2,1),JSON.stringify(h)===JSON.stringify(u)&&t.splice(1,1);let r=(t=t.map(e=>({...e,ox:.5,oy:.5}))).length;t[0].x===t[1].x?t[0].oy=+(t[0].y<t[1].y):t[0].ox=+(t[0].x<t[1].x),t[r-1].x===t[r-2].x&&(t[r-1].oy=+(t[r-1].y<t[r-2].y)),t[r-1].y===t[r-2].y&&(t[r-1].ox=+(t[r-1].x<t[r-2].x)),t=t.map(({x:t,y:l,ox:o,oy:r})=>({x:Y(t)+e*o,y:Y(l)+e*r})),d.lineWidth=l,d.strokeStyle=o,d.beginPath();let{x:n,y:i}=t.shift();d.moveTo(n,i),t.forEach(({x:e,y:t})=>d.lineTo(e,t)),d.stroke()},z=()=>{if(clearTimeout(v),!N()){for(;!M();)U();v=setTimeout(()=>{B(w.x,w.y,"red"),B(E.x,E.y,"red")},5e3)}d.clearRect(0,0,n,i),P(),X(),p.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&$(t,l,e)))},G=async()=>{H(),y.forEach((e,t)=>{if(O[t])return;let l=new Image;l.src=e,A[t]=l,l.onload=()=>{O[t]=!0,p.forEach((e,t)=>e.forEach((e,l)=>-1!==e&&$(t,l,e)))}}),z()};window.onload=G;