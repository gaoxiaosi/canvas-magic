const e=["./201.png","./202.png","./203.png","./204.png","./214.png"],t=256;/** @type {HTMLCanvasElement} */let r=document.createElement("canvas"),o=r.getContext("2d");r.width=600,r.height=600,r.style.cssText="position: absolute; top: 0; left: 0; bottom: 0; right: 0; margin: auto;",document.body.appendChild(r),document.body.style.backgroundColor="#F9F7EB";let l=Array.from({length:4},()=>[,,,,].fill(-1)),n=0,a=[],c=-1,i=[];// 图片对象数组
document.addEventListener("keydown",e=>{let t=d[e.key];t&&f(t,l,e.key)});const f=async(e,t,r)=>{a=[],c=-1;let o=e(t);if(o.toString()===t.toString())return;l=o;let n=await h(a,r);cancelAnimationFrame(n),g()},h=(e,r,n=t)=>new Promise(t=>{let a=(e,t)=>e.map(({index:e,val:o,start:l,end:n})=>{let a=(n-l)*t;return"ArrowUp"===r?{x:e,y:3-l-a,val:o}:"ArrowDown"===r?{x:e,y:l+a,val:o}:"ArrowLeft"===r?{x:3-l-a,y:e,val:o}:"ArrowRight"===r?{x:l+=a,y:e,val:o}:void 0}),c=null,i,f=[],h=null,s=r=>{c||(c=r),o.clearRect(0,0,600,600),v(),w(l),f.forEach(({x:e,y:t,val:r})=>y(e,t,r)),(i=r-c)<n?(f=a(e,i/n),requestAnimationFrame(s)):t(h)};h=requestAnimationFrame(s)}),s=e=>{c++;let t=[],r=!1,o=e.length;for(let l=o-1;l>=0;l--)-1!==e[l]&&(r&&e[l]===t[0]?(n=Math.max(++t[0],n),r=!1):(t.unshift(e[l]),r=!0),a.push({index:c,val:e[l],start:l,end:o-t.length}));return Array(o-t.length).fill(-1).concat(t)},m=e=>e[0].map((t,r)=>e.map(e=>e[r])),d={ArrowUp:e=>e.map(e=>s(e.reverse()).reverse()),ArrowDown:e=>e.map(e=>s(e)),ArrowLeft:e=>m(m(e).map(e=>s(e.reverse()).reverse())),ArrowRight:e=>m(m(e).map(e=>s(e)))},g=()=>{if(u())console.log("你赢了");else{let{x:e,y:t}=E(l);l[e][t]=0}o.clearRect(0,0,600,600),v(),A(l),p()&&console.log("你输了！")},u=()=>n===e.length-1,p=()=>{for(let e=0;e<4;e++)for(let t=0;t<4;t++)// 游戏未结束条件：1.本身是空值 2.下方没有相同值 3.右侧没有相同值
if(-1===l[e][t]||t<3&&l[e][t]===l[e][t+1]||e<3&&l[e][t]===l[e+1][t])return!1;return!0},y=(e,t,r)=>{o.drawImage(i[r],145*e+20,145*t+20,125,125)},w=e=>e.forEach((e,t)=>e.forEach((e,r)=>x(t,r))),A=e=>e.forEach((t,r)=>t.forEach((t,o)=>{x(r,o),-1!==e[r][o]&&y(r,o,e[r][o])})),v=()=>{o.fillStyle="#AD9D8F",o.fillRect(0,0,600,600)},x=(e,t,r="#C2B4A5")=>{o.fillStyle=r,o.fillRect(145*e+20,145*t+20,125,125)},E=e=>{let t=[];return e.forEach((r,o)=>r.forEach((r,l)=>-1===e[o][l]&&t.push({x:o,y:l}))),t[Math.floor(Math.random()*t.length)]};window.onload=()=>{for(let e=0;e<2;e++){let{x:e,y:t}=E(l);l[e][t]=0}e.forEach((e,t)=>{let r=new Image;r.src=e,i[t]=r,r.onload=function(){console.log("onload"),l.forEach((e,t)=>e.forEach((e,r)=>-1!==l[t][r]&&y(t,r,l[t][r])))}}),v(),A(l)};